<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Revision Management - MFNF Export - Technical Manual</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Technical documentation for the export project of Mathe fÃ¼r Nicht-Freaks (Serlo Hochschulmathematik)">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "../";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="../concepts.html"><strong aria-hidden="true">1.</strong> Concepts</a></li><li><a href="../guide.html"><strong aria-hidden="true">2.</strong> Guide</a></li><li><ol class="section"><li><a href="../sitemap_structure.html"><strong aria-hidden="true">2.1.</strong> Sitemap Structure</a></li></ol></li><li><a href="../template_specification.html"><strong aria-hidden="true">3.</strong> Template Specification</a></li><li><a href="../developers.html"><strong aria-hidden="true">4.</strong> Developer Documentation</a></li><li><ol class="section"><li><a href="../tools.html"><strong aria-hidden="true">4.1.</strong> Tools Overview</a></li><li><a href="../make_overview.html"><strong aria-hidden="true">4.2.</strong> Export Dependency Structure</a></li><li><a href="../repository_structure.html"><strong aria-hidden="true">4.3.</strong> Repository Structure</a></li><li><a href="../build_doc/intro.html"><strong aria-hidden="true">4.4.</strong> Build System Documentation</a></li><li><ol class="section"><li><a href="../build_doc/make_basics.html"><strong aria-hidden="true">4.4.1.</strong> Makfile Basics</a></li><li><a href="../build_doc/unify_articles_books.html"><strong aria-hidden="true">4.4.2.</strong> Unifying Articles and Books</a></li><li><a href="../build_doc/dependency_generation.html"><strong aria-hidden="true">4.4.3.</strong> Dynamic Dependency Generation</a></li><li><a href="../build_doc/revision_management.html" class="active"><strong aria-hidden="true">4.4.4.</strong> Revision Management</a></li><li><a href="../build_doc/adding_targets.html"><strong aria-hidden="true">4.4.5.</strong> Adding a new Target</a></li></ol></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">MFNF Export - Technical Manual</h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#revision-management" id="revision-management"><h1>Revision Management</h1></a>
<p>Since most input data we use currently comes in the form of WikiBooks articles, we need a way to keep track which version of the article we are using. MediaWiki uses numeric revision IDs vor this.</p>
<p>But most references to articles, like internal links or even sitemaps do not specify a specific article revision. Instead, they implicitly point to the <code>latest</code> revision of an article.</p>
<p>If we would just use the currently latest revision available on the server, we risk introducing inconsistencies: If we export the same book to different output formats, an article might change in the middle of the process and we end up with the content beeing different in HTML and PDF. Or even worse, a definition included from another article differs from the actual article, because it changed after section extraction. Yes, these cases are rare, but there is another important reason:</p>
<p><em>Reproducible builds</em>. We want to be able to build a book exactly as it was three weeks ago, even if the articles and included media files have been changed since then. This is primarily useful to be able to fall back on a known good state if some change in an article breaks the build. But it also helps with tracking down errors or tracking the evolution of the book content.</p>
<a class="header" href="#implementation" id="implementation"><h2>Implementation</h2></a>
<p>The revision of an article or media file which is currently considered <code>latest</code> is stored in a <em>revision lock file</em> (<code>$(REVISION_LOCK_FILE)</code>), when it is first queried. By default, this file is called <code>revisions.json</code>.</p>
<p>Every subseqent reference to <code>latest</code> for an article or media file is then resolved through this file, which effectively locks the article to this revision for every subsequent export, until <code>revisions.json</code> is updated or deleted.</p>
<p>This functionality is implemented in <code>mk/scripts/get_revisions.sh</code>. However, when a revision needs to be resolved in the build process, you should use the <code>article_revision</code> or <code>media_revision</code> functions defined in <code>utils.mk</code>, since they make sure to use the revision lock file properly.</p>
<p>Article revisions are a string of numbers (<code>812312</code>), while media revisions are timestamps (<code>2017-04-02T09:54:57Z</code>).</p>
<a class="header" href="#handling-build-targets-with-latest" id="handling-build-targets-with-latest"><h2>Handling Build Targets with <code>latest</code></h2></a>
<p>For most targets, the build system allows to specify <code>latest</code> instead of a static article or book revision (like <code>812312</code>). These are resolved as early as possible in both phases described above:</p>
<ul>
<li>During dependency generation phase, revision resolving happens during the parsing of <code>$(MAKECMDGOALS)</code> in <code>book.mk</code> or <code>article_book.mk</code>.</li>
<li>When a target is to be built, we need to make sure <code>make</code> cannot just assume <code>latest</code> as the correct revision. This is why every target makefile (<code>mk/targets/&lt;target&gt;.mk</code>) has a rule to catch these and has the same target with the actual revision ID as prerequisite.</li>
</ul>
<p>The first phase is (straight forward) functional make programming. The second measure is a bit more tricky to achieve:</p>
<pre><code class="language-makefile">$(EXPORT_DIR)/%book.tex: $(TARGET_RESOLVED_REVISION) $(HAS_LATEST_GUARD)
    $(LINK_BOOK_LATEST)
    $(LINK_LATEST_TARGET)

$(EXPORT_DIR)/%.book.tex: $(PARSE_PATH_SECONDARY) $(NO_LATEST_GUARD) $$(BOOK_DEP_FILE) $$(BOOK_DEP_INTERMEDIATE) 
    ...
</code></pre>
<p>Through this pattern, we force <code>make</code> to use the first rule if the book revision (or article revision for article exports) is <code>latest</code>. Only if no revision in the target path is <code>latest</code>, the latter rule may be used.</p>
<p>The most important macros here are:</p>
<ul>
<li><code>$(NO_LATEST_GUARD)</code>: Expands to an impossible prerequisite if there is any revision in the target path is <code>latest</code>, otherwise expands to nothing.</li>
<li><code>$(HAS_LATEST_GUARD)</code>: The logical opposite (there needs to be at least one <code>latest</code> revision).</li>
<li><code>$(TARGET_RESOLVED_REVISION)</code>: Expands to the the target path, but with every reference to <code>latest</code> revision resolved.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../build_doc/dependency_generation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../build_doc/adding_targets.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../build_doc/dependency_generation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../build_doc/adding_targets.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
